{% extends 'base.html' %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/projeto.css') }}">
{% endblock %}

{% block content %}
<div class="projeto-detalhes-container">
    <!-- Header do Projeto -->
    <div class="projeto-header">
        <div class="projeto-info">
            <div class="projeto-title-container">
                <h1>{{ projeto.nome }}</h1>
                <div class="projeto-menu">
                    <button class="menu-btn" onclick="toggleProjetoMenu()">‚ãÆ</button>
                    <div class="menu-dropdown" id="projetoMenuDropdown">
                        <button class="menu-item" onclick="sairDoProjeto()">Sair do Projeto</button>
                        {% if eh_criador %}
                        <!-- A fun√ß√£o de excluir projetos aparece APENAS para o criador -->
                        <button class="menu-item" onclick="excluirProjeto()">Excluir Projeto</button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% if projeto.descricao %}
            <p class="projeto-descricao">{{ projeto.descricao }}</p>
            {% endif %}
            <div class="projeto-meta">
                <span>Criado por: {{ criador.nome }}</span>
                <span>‚Ä¢</span>
                <span>{{ projeto.data_criacao.strftime('%d/%m/%Y') }}</span>
            </div>
        </div>
        
        <div class="projeto-actions">
            <!-- Bot√µes aparecem para criador E administradores -->
            {% if eh_criador or usuario_atual_eh_admin %}
            <button class="btn btn-primary" onclick="abrirModalTarefa()">+ Nova Tarefa</button>
            <button class="btn btn-secondary" onclick="abrirModalMembros()">üë• Gerenciar Membros</button>
            {% else %}
            <!-- Espa√ßo reservado para manter layout -->
            <div style="height: 40px; visibility: hidden;"></div>
            {% endif %}
        </div>
    </div>

    <!-- Filtros - LAYOUT CORRIGIDO -->
    <div class="filtros-container">
        <div class="filtros-header">
            <h3 class="filtros-titulo">Filtrar Tarefas</h3>
            <div class="filtros-actions">
                <button type="button" class="btn-filtrar" onclick="aplicarFiltros()">Aplicar Filtros</button>
                <button type="button" class="btn-limpar" onclick="limparFiltros()">Limpar</button>
            </div>
        </div>
        <form class="filtros-form" id="filtrosForm">
            <!-- BARRA DE PESQUISA POR NOME - ACIMA DOS DEMAIS FILTROS -->
            <div class="filtro-group filtro-pesquisa">
                <label for="filtroNome">Pesquisar por Nome</label>
                <input type="text" id="filtroNome" placeholder="Digite o nome da tarefa...">
            </div>
            
            <div class="filtro-group">
                <label for="filtroPrioridade">Prioridade</label>
                <select id="filtroPrioridade">
                    <option value="todas">Todas as Prioridades</option>
                    <option value="alta">Alta Prioridade</option>
                    <option value="media">M√©dia Prioridade</option>
                    <option value="baixa">Baixa Prioridade</option>
                </select>
            </div>
            
            <div class="filtro-group">
                <label for="filtroStatus">Status</label>
                <select id="filtroStatus">
                    <option value="todos">Todos os Status</option>
                    <option value="todo">Pendentes</option>
                    <option value="doing">Em Andamento</option>
                    <option value="done">Conclu√≠das</option>
                </select>
            </div>
            
            <div class="filtro-group">
                <label for="filtroResponsavel">Respons√°vel</label>
                <select id="filtroResponsavel">
                    <option value="todos">Todos os Respons√°veis</option>
                    <option value="{{ session['user_id'] }}">Eu ({{ session['user_name'] }})</option>
                    {% for membro in membros %}
                    <option value="{{ membro.id_usuario }}">{{ membro.nome }}</option>
                    {% endfor %}
                </select>
            </div>
        </form>
    </div>

    <!-- Layout Principal com Kanban e Estat√≠sticas na Lateral -->
    <div class="main-content-layout">
        <!-- Kanban Board - COM NOVOS CARDS -->
        <div class="kanban-board">
            <!-- PENDENTES -->
            <div class="kanban-column">
                <div class="column-header">
                    <h3>Pendentes</h3>
                    <span class="task-count">{{ tarefas_todo|length }}</span>
                </div>
                <div class="tasks-list" id="todo-column" data-status="todo" ondrop="drop(event)" ondragover="allowDrop(event)" ondragenter="handleDragEnter(event)" ondragleave="handleDragLeave(event)">
                    {% for tarefa in tarefas_todo %}
                    <div class="task-card-modern" draggable="true" ondragstart="drag(event)" data-task-id="{{ tarefa.id_tarefa }}" data-prioridade="{{ tarefa.prioridade }}" data-responsavel="{{ tarefa.id_responsavel }}">
                        <div class="task-content">
                            <div class="task-header-modern">
                                <h4>{{ tarefa.titulo }}</h4>
                                <span class="priority-badge-modern priority-{{ tarefa.prioridade }}-modern">{{ tarefa.prioridade }}</span>
                            </div>
                            {% if tarefa.descricao %}
                            <p class="task-description-modern">
                                {{ tarefa.descricao[:100] }}{% if tarefa.descricao|length > 100 %}...{% endif %}
                            </p>
                            {% endif %}
                            <div class="task-footer-modern">
                                <div class="responsavel-info">
                                    <div class="responsavel-avatar">
                                        {{ tarefa.responsavel_nome[:1]|upper }}
                                    </div>
                                    <span>{{ tarefa.responsavel_nome }}</span>
                                </div>
                                {% if tarefa.data_vencimento %}
                                <div class="due-date-modern">
                                    üìÖ {{ tarefa.data_vencimento.strftime('%d/%m/%Y') }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <!-- Bot√£o de excluir tarefa aparece APENAS para criador e administradores -->
                        {% if eh_criador or usuario_atual_eh_admin %}
                        <div class="task-actions">
                            <button class="btn-acao-tarefa" data-task-id="{{ tarefa.id_tarefa }}" data-action="excluir">üóëÔ∏è</button>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- EM ANDAMENTO -->
            <div class="kanban-column">
                <div class="column-header">
                    <h3>Em Andamento</h3>
                    <span class="task-count">{{ tarefas_doing|length }}</span>
                </div>
                <div class="tasks-list" id="doing-column" data-status="doing" ondrop="drop(event)" ondragover="allowDrop(event)" ondragenter="handleDragEnter(event)" ondragleave="handleDragLeave(event)">
                    {% for tarefa in tarefas_doing %}
                    <div class="task-card-modern" draggable="true" ondragstart="drag(event)" data-task-id="{{ tarefa.id_tarefa }}" data-prioridade="{{ tarefa.prioridade }}" data-responsavel="{{ tarefa.id_responsavel }}">
                        <div class="task-content">
                            <div class="task-header-modern">
                                <h4>{{ tarefa.titulo }}</h4>
                                <span class="priority-badge-modern priority-{{ tarefa.prioridade }}-modern">{{ tarefa.prioridade }}</span>
                            </div>
                            {% if tarefa.descricao %}
                            <p class="task-description-modern">
                                {{ tarefa.descricao[:100] }}{% if tarefa.descricao|length > 100 %}...{% endif %}
                            </p>
                            {% endif %}
                            <div class="task-footer-modern">
                                <div class="responsavel-info">
                                    <div class="responsavel-avatar">
                                        {{ tarefa.responsavel_nome[:1]|upper }}
                                    </div>
                                    <span>{{ tarefa.responsavel_nome }}</span>
                                </div>
                                {% if tarefa.data_vencimento %}
                                <div class="due-date-modern">
                                    üìÖ {{ tarefa.data_vencimento.strftime('%d/%m/%Y') }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <!-- Bot√£o de excluir tarefa aparece APENAS para criador e administradores -->
                        {% if eh_criador or usuario_atual_eh_admin %}
                        <div class="task-actions">
                            <button class="btn-acao-tarefa" data-task-id="{{ tarefa.id_tarefa }}" data-action="excluir">üóëÔ∏è</button>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- CONCLU√çDAS -->
            <div class="kanban-column">
                <div class="column-header">
                    <h3>Conclu√≠das</h3>
                    <span class="task-count">{{ tarefas_done|length }}</span>
                </div>
                <div class="tasks-list" id="done-column" data-status="done" ondrop="drop(event)" ondragover="allowDrop(event)" ondragenter="handleDragEnter(event)" ondragleave="handleDragLeave(event)">
                    {% for tarefa in tarefas_done %}
                    <div class="task-card-modern" draggable="true" ondragstart="drag(event)" data-task-id="{{ tarefa.id_tarefa }}" data-prioridade="{{ tarefa.prioridade }}" data-responsavel="{{ tarefa.id_responsavel }}">
                        <div class="task-content">
                            <div class="task-header-modern">
                                <h4>{{ tarefa.titulo }}</h4>
                                <span class="priority-badge-modern priority-{{ tarefa.prioridade }}-modern">{{ tarefa.prioridade }}</span>
                            </div>
                            {% if tarefa.descricao %}
                            <p class="task-description-modern">
                                {{ tarefa.descricao[:100] }}{% if tarefa.descricao|length > 100 %}...{% endif %}
                            </p>
                            {% endif %}
                            <div class="task-footer-modern">
                                <div class="responsavel-info">
                                    <div class="responsavel-avatar">
                                        {{ tarefa.responsavel_nome[:1]|upper }}
                                    </div>
                                    <span>{{ tarefa.responsavel_nome }}</span>
                                </div>
                                {% if tarefa.data_vencimento %}
                                <div class="due-date-modern">
                                    üìÖ {{ tarefa.data_vencimento.strftime('%d/%m/%Y') }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <!-- Bot√£o de excluir tarefa aparece APENAS para criador e administradores -->
                        {% if eh_criador or usuario_atual_eh_admin %}
                        <div class="task-actions">
                            <button class="btn-acao-tarefa" data-task-id="{{ tarefa.id_tarefa }}" data-action="excluir">üóëÔ∏è</button>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Estat√≠sticas R√°pidas - NOVO LAYOUT NA LATERAL DIREITA -->
        <div class="estatisticas-lateral">
            <div class="estatistica-card membros" onclick="abrirModalListaMembros()" style="cursor: pointer;">
                <div class="estatistica-numero">{{ membros|length + 1 }}</div>
                <div class="estatistica-label">Membros</div>
            </div>
            <div class="estatistica-card pendentes">
                <div class="estatistica-numero">{{ tarefas_todo|length }}</div>
                <div class="estatistica-label">Pendentes</div>
            </div>
            <div class="estatistica-card andamento">
                <div class="estatistica-numero">{{ tarefas_doing|length }}</div>
                <div class="estatistica-label">Em Andamento</div>
            </div>
            <div class="estatistica-card concluidas">
                <div class="estatistica-numero">{{ tarefas_done|length }}</div>
                <div class="estatistica-label">Conclu√≠das</div>
            </div>
        </div>
    </div>
</div>

<!-- Modais -->
<!-- Modais de Tarefa e Gerenciar Membros aparecem para criador E administradores -->
{% if eh_criador or usuario_atual_eh_admin %}
<div id="modalTarefa" class="modal">
    <div class="modal-content">
        <span class="close" onclick="fecharModalTarefa()">&times;</span>
        <h2>Nova Tarefa</h2>
        <form id="formTarefa" method="POST" action="{{ url_for('task.criar_tarefa', id_projeto=projeto.id_projeto) }}">
            <input type="text" name="titulo" placeholder="T√≠tulo da tarefa" required>
            <textarea name="descricao" placeholder="Descri√ß√£o (opcional)" rows="4"></textarea>
            
            <label>Prioridade:</label>
            <select name="prioridade">
                <option value="baixa">Baixa Prioridade</option>
                <option value="media" selected>M√©dia Prioridade</option>
                <option value="alta">Alta Prioridade</option>
            </select>
            
            <label>Data de Vencimento:</label>
            <input type="date" name="data_vencimento" required>
            <small class="required-hint">* Campo obrigat√≥rio</small>
            
            <label>Respons√°vel:</label>
            <select name="id_responsavel">
                <option value="{{ session['user_id'] }}">Eu ({{ session['user_name'] }})</option>
                {% for membro in membros %}
                <option value="{{ membro.id_usuario }}">{{ membro.nome }}</option>
                {% endfor %}
            </select>
            
            <button type="submit" class="btn btn-primary">Criar Tarefa</button>
        </form>
    </div>
</div>

<div id="modalMembros" class="modal">
    <div class="modal-content">
        <span class="close" onclick="fecharModalMembros()">&times;</span>
        <h2>Gerenciar Membros</h2>
        
        <div class="add-member-form">
            <h3>Adicionar Membro</h3>
            <div class="input-group">
                <input type="email" id="emailMembro" placeholder="Email do usu√°rio">
                <button type="button" onclick="adicionarMembro()" class="btn btn-primary">Adicionar</button>
            </div>
        </div>
        
        <div class="members-list">
            <h3>Membros do Projeto</h3>
            <div class="member-item creator">
                <span>{{ criador.nome }} (Criador)</span>
            </div>
            {% for membro in membros %}
            <div class="member-item">
                <span>{{ membro.nome }} - {{ membro.email }}</span>
                <button type="button" onclick="removerMembro({{ membro.id_usuario }})" class="btn btn-danger btn-sm">Remover</button>
            </div>
            {% endfor %}
            <div class="convites-pendentes">
                <h3>Convites Pendentes</h3>
                {% if convites_pendentes %}
                    {% for convite in convites_pendentes %}
                    <div class="convite-item">
                        <span>{{ convite.nome }} - {{ convite.email }}</span>
                        <small>(Convite expira: {{ convite.data_expiracao.strftime('%d/%m/%Y') }})</small>
                        <button type="button" 
                                onclick="cancelarConvite({{ convite.id_convite }})" 
                                class="btn btn-danger btn-sm">
                            Cancelar
                        </button>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="no-convites">Nenhum convite pendente</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal Excluir Projeto aparece APENAS para o criador -->
{% if eh_criador %}
<div id="modalExcluirProjeto" class="modal">
    <div class="modal-content">
        <h2>Confirmar Exclus√£o</h2>
        <p>Tem certeza que deseja excluir o projeto <strong>"{{ projeto.nome }}"</strong>?</p>
        <p class="warning-text">‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita! Todas as tarefas e dados ser√£o perdidos.</p><br>
        <div class="modal-actions">
            <button type="button" onclick="fecharModalExcluir()" class="btn btn-secondary">Cancelar</button>
            <form id="formExcluirProjeto" method="POST" action="{{ url_for('work.excluir_projeto', id_projeto=projeto.id_projeto) }}" style="display: inline;">
                <button type="submit" class="btn btn-danger">Sim, Excluir Projeto</button>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal Sair do Projeto (aparece para todos) -->
<div id="modalSairProjeto" class="modal">
    <div class="modal-content">
        <h2>Confirmar Sa√≠da</h2>
        <p>Tem certeza que deseja sair do projeto <strong>"{{ projeto.nome }}"</strong>?</p>
        <p class="warning-text">‚ö†Ô∏è Voc√™ perder√° acesso a todas as tarefas e informa√ß√µes deste projeto.</p>
        <br>
        <div class="modal-actions">
            <button type="button" onclick="fecharModalSair()" class="btn btn-secondary">Cancelar</button>
            <form id="formSairProjeto" method="POST" action="{{ url_for('work.sair_do_projeto', id_projeto=projeto.id_projeto) }}" style="display: inline;">
                <button type="submit" class="btn btn-danger">Sim, Sair do Projeto</button>
            </form>
        </div>
    </div>
</div>

<!-- Modal Lista de Membros (aparece para todos) -->
<div id="modalListaMembros" class="modal">
    <div class="modal-content">
        <span class="close" onclick="fecharModalListaMembros()">&times;</span>
        <h2>Membros do Projeto</h2>
        
        <div class="membros-lista-container">
            <!-- Criador do Projeto -->
            <div class="membro-item criador">
                <div class="membro-info">
                    <div class="membro-avatar">
                        {{ criador.nome[:1]|upper }}
                    </div>
                    <div class="membro-detalhes">
                        <span class="membro-nome">{{ criador.nome }}</span>
                        <span class="membro-email">{{ criador.email }}</span>
                        <span class="membro-cargo">Criador</span>
                    </div>
                </div>
                <div class="membro-acoes">
                    <span class="criador-badge">üëë Criador</span>
                </div>
            </div>

            <!-- Membros Administradores -->
            {% for membro in membros if membro.eh_administrador %}
            <div class="membro-item administrador">
                <div class="membro-info">
                    <div class="membro-avatar">
                        {{ membro.nome[:1]|upper }}
                    </div>
                    <div class="membro-detalhes">
                        <span class="membro-nome">{{ membro.nome }}</span>
                        <span class="membro-email">{{ membro.email }}</span>
                        <span class="membro-cargo">Administrador</span>
                    </div>
                </div>
                <div class="membro-acoes">
                    {% if eh_criador or usuario_atual_eh_admin %}
                    <div class="membro-menu">
                        <button class="menu-btn-membro" onclick="toggleMembroMenu({{ membro.id_usuario }})">‚ãÆ</button>
                        <div class="menu-dropdown-membro" id="menuMembro{{ membro.id_usuario }}">
                            <button class="menu-item" onclick="rebaixarMembro({{ membro.id_usuario }})">Rebaixar Membro</button>
                            <button class="menu-item btn-remover" onclick="removerMembroModal({{ membro.id_usuario }})">Remover</button>
                        </div>
                    </div>
                    {% else %}
                    <span class="admin-badge">üõ°Ô∏è Admin</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}

            <!-- Membros Normais -->
            {% for membro in membros if not membro.eh_administrador %}
            <div class="membro-item membro-normal">
                <div class="membro-info">
                    <div class="membro-avatar">
                        {{ membro.nome[:1]|upper }}
                    </div>
                    <div class="membro-detalhes">
                        <span class="membro-nome">{{ membro.nome }}</span>
                        <span class="membro-email">{{ membro.email }}</span>
                        <span class="membro-cargo">Membro</span>
                    </div>
                </div>
                <div class="membro-acoes">
                    {% if eh_criador or usuario_atual_eh_admin %}
                    <div class="membro-menu">
                        <button class="menu-btn-membro" onclick="toggleMembroMenu({{ membro.id_usuario }})">‚ãÆ</button>
                        <div class="menu-dropdown-membro" id="menuMembro{{ membro.id_usuario }}">
                            <button class="menu-item" onclick="tornarAdministrador({{ membro.id_usuario }})">Tornar Administrador</button>
                            <button class="menu-item btn-remover" onclick="removerMembroModal({{ membro.id_usuario }})">Remover</button>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="modal-actions">
            <button type="button" onclick="fecharModalListaMembros()" class="btn btn-secondary">Fechar</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/projeto.js') }}"></script>
{% endblock scripts %}