{% extends 'base.html' %}

{% block content %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ projeto.nome }} - FofoTech</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/projeto.css') }}">
</head>
<body>
    <div class="projeto-detalhes-container">
        <!-- Header do Projeto -->
        <div class="projeto-header">
            <div class="projeto-info">
                <h1>{{ projeto.nome }}</h1>
                {% if projeto.descricao %}
                <p class="projeto-descricao">{{ projeto.descricao }}</p>
                {% endif %}
                <div class="projeto-meta">
                    <span>Criado por: {{ criador.nome }}</span>
                    <span>‚Ä¢</span>
                    <span>{{ projeto.data_criacao.strftime('%d/%m/%Y') }}</span>
                </div>
            </div>
            
            <div class="projeto-actions">
                {% if eh_criador %}
                <button class="btn btn-primary" onclick="abrirModalTarefa()">+ Nova Tarefa</button>
                <button class="btn btn-secondary" onclick="abrirModalMembros()">üë• Gerenciar Membros</button>
                <button class="btn btn-danger" onclick="excluirProjeto()">üóëÔ∏è Excluir Projeto</button>
                {% endif %}
            </div>
        </div>

        <!-- Estat√≠sticas R√°pidas -->
        <div class="projeto-stats">
            <div class="stat-card">
                <h3>A Fazer</h3>
                <span class="stat-number">{{ tarefas_todo|length }}</span>
            </div>
            <div class="stat-card">
                <h3>Fazendo</h3>
                <span class="stat-number">{{ tarefas_doing|length }}</span>
            </div>
            <div class="stat-card">
                <h3>Conclu√≠do</h3>
                <span class="stat-number">{{ tarefas_done|length }}</span>
            </div>
            <div class="stat-card">
                <h3>Membros</h3>
                <span class="stat-number">{{ membros|length + 1 }}</span>
            </div>
        </div>

        <!-- Kanban Board -->
        <div class="kanban-board">
            <!-- TO DO -->
            <div class="kanban-column">
                <div class="column-header">
                    <h3>A Fazer</h3>
                    <span class="task-count">{{ tarefas_todo|length }}</span>
                </div>
                <div class="tasks-list" id="todo-column" ondrop="drop(event)" ondragover="allowDrop(event)">
                    {% for tarefa in tarefas_todo %}
                    <div class="task-card" draggable="true" ondragstart="drag(event)" data-task-id="{{ tarefa.id_tarefa }}">
                        <div class="task-header">
                            <h4>{{ tarefa.titulo }}</h4>
                            <span class="priority-badge priority-{{ tarefa.prioridade }}">{{ tarefa.prioridade }}</span>
                        </div>
                        {% if tarefa.descricao %}
                        <p class="task-description">
                            {{ tarefa.descricao[:100] }}{% if tarefa.descricao|length > 100 %}...{% endif %}
                        </p>
                        {% endif %}
                        <div class="task-footer">
                            <small>Por: {{ tarefa.criador_nome }}</small>
                            {% if tarefa.data_vencimento %}
                            <small class="due-date">üìÖ {{ tarefa.data_vencimento.strftime('%d/%m/%Y') }}</small>
                            {% endif %}
                        </div>
                        {% if eh_criador %}
                        <div class="task-actions">
                            <button onclick="editarTarefa({{ tarefa.id_tarefa }})">‚úèÔ∏è</button>
                            <button onclick="excluirTarefa({{ tarefa.id_tarefa }})">üóëÔ∏è</button>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- DOING -->
            <div class="kanban-column">
                <div class="column-header">
                    <h3>Fazendo</h3>
                    <span class="task-count">{{ tarefas_doing|length }}</span>
                </div>
                <div class="tasks-list" id="doing-column" ondrop="drop(event)" ondragover="allowDrop(event)">
                    {% for tarefa in tarefas_doing %}
                    <div class="task-card" draggable="true" ondragstart="drag(event)" data-task-id="{{ tarefa.id_tarefa }}">
                        <div class="task-header">
                            <h4>{{ tarefa.titulo }}</h4>
                            <span class="priority-badge priority-{{ tarefa.prioridade }}">{{ tarefa.prioridade }}</span>
                        </div>
                        {% if tarefa.descricao %}
                        <p class="task-description">
                            {{ tarefa.descricao[:100] }}{% if tarefa.descricao|length > 100 %}...{% endif %}
                        </p>
                        {% endif %}
                        <div class="task-footer">
                            <small>Por: {{ tarefa.criador_nome }}</small>
                            {% if tarefa.data_vencimento %}
                            <small class="due-date">üìÖ {{ tarefa.data_vencimento.strftime('%d/%m/%Y') }}</small>
                            {% endif %}
                        </div>
                        {% if eh_criador %}
                        <div class="task-actions">
                            <button onclick="editarTarefa({{ tarefa.id_tarefa }})">‚úèÔ∏è</button>
                            <button onclick="excluirTarefa({{ tarefa.id_tarefa }})">üóëÔ∏è</button>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- DONE -->
            <div class="kanban-column">
                <div class="column-header">
                    <h3>Conclu√≠do</h3>
                    <span class="task-count">{{ tarefas_done|length }}</span>
                </div>
                <div class="tasks-list" id="done-column" ondrop="drop(event)" ondragover="allowDrop(event)">
                    {% for tarefa in tarefas_done %}
                    <div class="task-card" draggable="true" ondragstart="drag(event)" data-task-id="{{ tarefa.id_tarefa }}">
                        <div class="task-header">
                            <h4>{{ tarefa.titulo }}</h4>
                            <span class="priority-badge priority-{{ tarefa.prioridade }}">{{ tarefa.prioridade }}</span>
                        </div>
                        {% if tarefa.descricao %}
                        <p class="task-description">
                            {{ tarefa.descricao[:100] }}{% if tarefa.descricao|length > 100 %}...{% endif %}
                        </p>
                        {% endif %}
                        <div class="task-footer">
                            <small>Por: {{ tarefa.criador_nome }}</small>
                            {% if tarefa.data_vencimento %}
                            <small class="due-date">üìÖ {{ tarefa.data_vencimento.strftime('%d/%m/%Y') }}</small>
                            {% endif %}
                        </div>
                        {% if eh_criador %}
                        <div class="task-actions">
                            <button onclick="editarTarefa({{ tarefa.id_tarefa }})">‚úèÔ∏è</button>
                            <button onclick="excluirTarefa({{ tarefa.id_tarefa }})">üóëÔ∏è</button>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nova Tarefa -->
    {% if eh_criador %}
    <div id="modalTarefa" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModalTarefa()">&times;</span>
            <h2>Nova Tarefa</h2>
            <!-- üîß CORRE√á√ÉO AQUI -->
            <form id="formTarefa" method="POST" action="{{ url_for('task.criar_tarefa', id_projeto=projeto.id_projeto) }}">
                <input type="text" name="titulo" placeholder="T√≠tulo da tarefa" required>
                <textarea name="descricao" placeholder="Descri√ß√£o (opcional)" rows="4"></textarea>
                
                <label>Prioridade:</label>
                <select name="prioridade">
                    <option value="baixa">Baixa Prioridade</option>
                    <option value="media" selected>M√©dia Prioridade</option>
                    <option value="alta">Alta Prioridade</option>
                </select>
                
                <label>Data de Vencimento:</label>
                <input type="date" name="data_vencimento">
                
                <label>Respons√°vel:</label>
                <select name="id_responsavel">
                    <option value="{{ session['user_id'] }}">Eu</option>
                    {% for membro in membros %}
                    <option value="{{ membro.id_usuario }}">{{ membro.nome }}</option>
                    {% endfor %}
                </select>
                
                <button type="submit" class="btn btn-primary">Criar Tarefa</button>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- Modal Gerenciar Membros -->
    {% if eh_criador %}
    <div id="modalMembros" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModalMembros()">&times;</span>
            <h2>Gerenciar Membros</h2>
            
            <div class="add-member-form">
                <h3>Adicionar Membro</h3>
                <div class="input-group">
                    <input type="email" id="emailMembro" placeholder="Email do usu√°rio">
                    <button onclick="adicionarMembro()" class="btn btn-primary">Adicionar</button>
                </div>
            </div>
            
            <div class="members-list">
                <h3>Membros do Projeto</h3>
                <div class="member-item creator">
                    <span>{{ criador.nome }} (Criador)</span>
                </div>
                {% for membro in membros %}
                <div class="member-item">
                    <span>{{ membro.nome }} - {{ membro.email }}</span>
                    <button onclick="removerMembro({{ membro.id_usuario }})" class="btn btn-danger btn-sm">Remover</button>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Modal Confirmar Exclus√£o -->
    {% if eh_criador %}
    <div id="modalExcluirProjeto" class="modal">
        <div class="modal-content">
            <h2>Confirmar Exclus√£o</h2>
            <p>Tem certeza que deseja excluir o projeto <strong>"{{ projeto.nome }}"</strong>?</p>
            <p class="warning-text">‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita! Todas as tarefas e dados ser√£o perdidos.</p>
            <div class="modal-actions">
                <button onclick="fecharModalExcluir()" class="btn btn-secondary">Cancelar</button>
                <form id="formExcluirProjeto" method="POST" action="{{ url_for('work.excluir_projeto', id_projeto=projeto.id_projeto) }}" style="display: inline;">
                    <button type="submit" class="btn btn-danger">Sim, Excluir Projeto</button>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
    
    <script src="{{ url_for('static', filename='js/projeto.js') }}"></script>
</body>
</html>
{% endblock %}
