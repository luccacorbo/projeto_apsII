{% extends 'base.html' %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/projeto.css') }}">
{% endblock %}

{% block content %}
<div class="projeto-detalhes-container">
    <!-- Header do Projeto -->
    <div class="projeto-header">
        <div class="projeto-info">
            <div class="projeto-title-container">
                <h1>{{ projeto.nome }}</h1>
                <div class="projeto-menu">
                    <button class="menu-btn" onclick="toggleProjetoMenu()">‚ãÆ</button>
                    <div class="menu-dropdown" id="projetoMenuDropdown">
                        <button class="menu-item" onclick="sairDoProjeto()">Sair do Projeto</button>
                        {% if eh_criador %}
                        <button class="menu-item" onclick="excluirProjeto()">Excluir Projeto</button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% if projeto.descricao %}
            <p class="projeto-descricao">{{ projeto.descricao }}</p>
            {% endif %}
            <div class="projeto-meta">
                <span>Criado por: {{ criador.nome }}</span>
                <span>‚Ä¢</span>
                <span>{{ projeto.data_criacao.strftime('%d/%m/%Y') }}</span>
            </div>
        </div>
        
        <div class="projeto-actions">
            {% if eh_criador %}
            <button class="btn btn-primary" onclick="abrirModalTarefa()">+ Nova Tarefa</button>
            <button class="btn btn-secondary" onclick="abrirModalMembros()">üë• Gerenciar Membros</button>
            {% else %}
            <!-- Espa√ßo reservado para manter layout -->
            <div style="height: 40px; visibility: hidden;"></div>
            {% endif %}
        </div>
    </div>

    <!-- Estat√≠sticas R√°pidas - SEMPRE 4 CARDS EM GRID 2x2 -->
    <div class="projeto-stats">
        <div class="stat-card">
            <h3>Pendentes</h3>
            <span class="stat-number">{{ tarefas_todo|length }}</span>
        </div>
        <div class="stat-card">
            <h3>Em Andamento</h3>
            <span class="stat-number">{{ tarefas_doing|length }}</span>
        </div>
        <div class="stat-card">
            <h3>Conclu√≠das</h3>
            <span class="stat-number">{{ tarefas_done|length }}</span>
        </div>
        <div class="stat-card">
            <h3>Membros</h3>
            <span class="stat-number">{{ membros|length + 1 }}</span>
        </div>
    </div>

    <!-- Kanban Board - SEMPRE 3 COLUNAS -->
    <div class="kanban-board">
        <!-- PENDENTES -->
        <div class="kanban-column">
            <div class="column-header">
                <h3>Pendentes</h3>
                <span class="task-count">{{ tarefas_todo|length }}</span>
            </div>
            <div class="tasks-list" id="todo-column" data-status="todo" ondrop="drop(event)" ondragover="allowDrop(event)" ondragenter="handleDragEnter(event)" ondragleave="handleDragLeave(event)">
                {% for tarefa in tarefas_todo %}
                <div class="task-card" draggable="true" ondragstart="drag(event)" data-task-id="{{ tarefa.id_tarefa }}">
                    <div class="task-content">
                        <div class="task-header">
                            <h4>{{ tarefa.titulo }}</h4>
                            <span class="priority-badge priority-{{ tarefa.prioridade }}">{{ tarefa.prioridade }}</span>
                        </div>
                        {% if tarefa.descricao %}
                        <p class="task-description">
                            {{ tarefa.descricao[:100] }}{% if tarefa.descricao|length > 100 %}...{% endif %}
                        </p>
                        {% endif %}
                        <div class="task-footer">
                            <small>Por: {{ tarefa.criador_nome }}</small>
                            {% if tarefa.data_vencimento %}
                            <small class="due-date">üìÖ {{ tarefa.data_vencimento.strftime('%d/%m/%Y') }}</small>
                            {% endif %}
                        </div>
                    </div>
                    {% if eh_criador %}
                    <div class="task-actions">
                        <button onclick="editarTarefa({{ tarefa.id_tarefa }})">‚úèÔ∏è</button>
                        <button onclick="excluirTarefa({{ tarefa.id_tarefa }})">üóëÔ∏è</button>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- EM ANDAMENTO -->
        <div class="kanban-column">
            <div class="column-header">
                <h3>Em Andamento</h3>
                <span class="task-count">{{ tarefas_doing|length }}</span>
            </div>
            <div class="tasks-list" id="doing-column" data-status="doing" ondrop="drop(event)" ondragover="allowDrop(event)" ondragenter="handleDragEnter(event)" ondragleave="handleDragLeave(event)">
                {% for tarefa in tarefas_doing %}
                <div class="task-card" draggable="true" ondragstart="drag(event)" data-task-id="{{ tarefa.id_tarefa }}">
                    <div class="task-content">
                        <div class="task-header">
                            <h4>{{ tarefa.titulo }}</h4>
                            <span class="priority-badge priority-{{ tarefa.prioridade }}">{{ tarefa.prioridade }}</span>
                        </div>
                        {% if tarefa.descricao %}
                        <p class="task-description">
                            {{ tarefa.descricao[:100] }}{% if tarefa.descricao|length > 100 %}...{% endif %}
                        </p>
                        {% endif %}
                        <div class="task-footer">
                            <small>Por: {{ tarefa.criador_nome }}</small>
                            {% if tarefa.data_vencimento %}
                            <small class="due-date">üìÖ {{ tarefa.data_vencimento.strftime('%d/%m/%Y') }}</small>
                            {% endif %}
                        </div>
                    </div>
                    {% if eh_criador %}
                    <div class="task-actions">
                        <button onclick="editarTarefa({{ tarefa.id_tarefa }})">‚úèÔ∏è</button>
                        <button onclick="excluirTarefa({{ tarefa.id_tarefa }})">üóëÔ∏è</button>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- CONCLU√çDAS -->
        <div class="kanban-column">
            <div class="column-header">
                <h3>Conclu√≠das</h3>
                <span class="task-count">{{ tarefas_done|length }}</span>
            </div>
            <div class="tasks-list" id="done-column" data-status="done" ondrop="drop(event)" ondragover="allowDrop(event)" ondragenter="handleDragEnter(event)" ondragleave="handleDragLeave(event)">
                {% for tarefa in tarefas_done %}
                <div class="task-card" draggable="true" ondragstart="drag(event)" data-task-id="{{ tarefa.id_tarefa }}">
                    <div class="task-content">
                        <div class="task-header">
                            <h4>{{ tarefa.titulo }}</h4>
                            <span class="priority-badge priority-{{ tarefa.prioridade }}">{{ tarefa.prioridade }}</span>
                        </div>
                        {% if tarefa.descricao %}
                        <p class="task-description">
                            {{ tarefa.descricao[:100] }}{% if tarefa.descricao|length > 100 %}...{% endif %}
                        </p>
                        {% endif %}
                        <div class="task-footer">
                            <small>Por: {{ tarefa.criador_nome }}</small>
                            {% if tarefa.data_vencimento %}
                            <small class="due-date">üìÖ {{ tarefa.data_vencimento.strftime('%d/%m/%Y') }}</small>
                            {% endif %}
                        </div>
                    </div>
                    {% if eh_criador %}
                    <div class="task-actions">
                        <button onclick="editarTarefa({{ tarefa.id_tarefa }})">‚úèÔ∏è</button>
                        <button onclick="excluirTarefa({{ tarefa.id_tarefa }})">üóëÔ∏è</button>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Modais -->
{% if eh_criador %}
<div id="modalTarefa" class="modal">
    <div class="modal-content">
        <span class="close" onclick="fecharModalTarefa()">&times;</span>
        <h2>Nova Tarefa</h2>
        <form id="formTarefa" method="POST" action="{{ url_for('task.criar_tarefa', id_projeto=projeto.id_projeto) }}">
            <input type="text" name="titulo" placeholder="T√≠tulo da tarefa" required>
            <textarea name="descricao" placeholder="Descri√ß√£o (opcional)" rows="4"></textarea>
            
            <label>Prioridade:</label>
            <select name="prioridade">
                <option value="baixa">Baixa Prioridade</option>
                <option value="media" selected>M√©dia Prioridade</option>
                <option value="alta">Alta Prioridade</option>
            </select>
            
            <label>Data de Vencimento:</label>
            <input type="date" name="data_vencimento">
            
            <label>Respons√°vel:</label>
            <select name="id_responsavel">
                <option value="{{ session['user_id'] }}">Eu</option>
                {% for membro in membros %}
                <option value="{{ membro.id_usuario }}">{{ membro.nome }}</option>
                {% endfor %}
            </select>
            
            <button type="submit" class="btn btn-primary">Criar Tarefa</button>
        </form>
    </div>
</div>

<div id="modalMembros" class="modal">
    <div class="modal-content">
        <span class="close" onclick="fecharModalMembros()">&times;</span>
        <h2>Gerenciar Membros</h2>
        
        <div class="add-member-form">
            <h3>Adicionar Membro</h3>
            <div class="input-group">
                <input type="email" id="emailMembro" placeholder="Email do usu√°rio">
                <button type="button" onclick="adicionarMembro()" class="btn btn-primary">Adicionar</button>
            </div>
        </div>
        
        <div class="members-list">
            <h3>Membros do Projeto</h3>
            <div class="member-item creator">
                <span>{{ criador.nome }} (Criador)</span>
            </div>
            {% for membro in membros %}
            <div class="member-item">
                <span>{{ membro.nome }} - {{ membro.email }}</span>
                <button type="button" onclick="removerMembro({{ membro.id_usuario }})" class="btn btn-danger btn-sm">Remover</button>
            </div>
            {% endfor %}
            <div class="convites-pendentes">
                <h3>Convites Pendentes</h3>
                {% if convites_pendentes %}
                    {% for convite in convites_pendentes %}
                    <div class="convite-item">
                        <span>{{ convite.nome }} - {{ convite.email }}</span>
                        <small>(Convite expira: {{ convite.data_expiracao.strftime('%d/%m/%Y') }})</small>
                        <button type="button" 
                                onclick="cancelarConvite({{ convite.id_convite }})" 
                                class="btn btn-danger btn-sm">
                            Cancelar
                        </button>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="no-convites">Nenhum convite pendente</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div id="modalExcluirProjeto" class="modal">
    <div class="modal-content">
        <h2>Confirmar Exclus√£o</h2>
        <p>Tem certeza que deseja excluir o projeto <strong>"{{ projeto.nome }}"</strong>?</p>
        <p class="warning-text">‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita! Todas as tarefas e dados ser√£o perdidos.</p><br>
        <div class="modal-actions">
            <button type="button" onclick="fecharModalExcluir()" class="btn btn-secondary">Cancelar</button>
            <form id="formExcluirProjeto" method="POST" action="{{ url_for('work.excluir_projeto', id_projeto=projeto.id_projeto) }}" style="display: inline;">
                <button type="submit" class="btn btn-danger">Sim, Excluir Projeto</button>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal Sair do Projeto (aparece para todos) -->
<div id="modalSairProjeto" class="modal">
    <div class="modal-content">
        <h2>Confirmar Sa√≠da</h2>
        <p>Tem certeza que deseja sair do projeto <strong>"{{ projeto.nome }}"</strong>?</p>
        <p class="warning-text">‚ö†Ô∏è Voc√™ perder√° acesso a todas as tarefas e informa√ß√µes deste projeto.</p>
        <br>
        <div class="modal-actions">
            <button type="button" onclick="fecharModalSair()" class="btn btn-secondary">Cancelar</button>
            <form id="formSairProjeto" method="POST" action="{{ url_for('work.sair_do_projeto', id_projeto=projeto.id_projeto) }}" style="display: inline;">
                <button type="submit" class="btn btn-danger">Sim, Sair do Projeto</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/projeto.js') }}"></script>
{% endblock %}