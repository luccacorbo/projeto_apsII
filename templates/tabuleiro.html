{% extends "base.html" %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/tabuleiro.css') }}">
{% endblock %}

{% block content %}
<div class="page-tabuleiro">
  <div class="tabuleiro-container">
    
    <!-- Lado Esquerdo - Tabuleiro -->
    <div class="tabuleiro-lado">
      <h1>Tabuleiro de Recompensas - {{ projeto.nome }}</h1>
      <p class="sub">Jogue o dado e avance para ganhar recompensas!</p>

      <div id="tabuleiro"
           class="tabuleiro"
           data-total-casas="100"
           data-por-linha="10"
           data-username="{{ nome_usuario or 'Jogador' }}">
      </div>
    </div>

    <!-- Lado Direito - Controles -->
    <div class="controles-lado">
      
      <!-- Painel do Dado -->
      <div class="painel-dado">
        <h3>ğŸ² Seu Dado</h3>
        <div class="dado-wrap" aria-live="polite">
          <div id="dado" class="dado-2d" role="img" aria-label="Face do dado">â€“</div>
          <p class="resultado">Ãšltimo resultado:</p>
          <div class="resultado-numero" id="res-num">â€“</div>
        </div>
        
        <!-- Container do botÃ£o girar e saldo -->
        <div class="btn-girar-container">
          <button type="button" id="btnGirarDado" class="btn-girar-dado" onclick="rolarDado()">
            ğŸ² Girar Dado
          </button>
          <div class="saldo-container">
            <div class="saldo-label">Saldo:</div>
            <div class="saldo-valor" id="saldo-valor">0</div>
          </div>
        </div>
      </div>

      <!-- Painel de UsuÃ¡rios -->
      <div class="painel-usuarios">
        <h3>ğŸ‘¥ Membros do Projeto</h3>
        <div class="lista-usuarios" id="lista-usuarios">
          <div class="sem-dados">Carregando membros...</div>
        </div>
      </div>

      <!-- Painel de AÃ§Ãµes -->
      <div class="painel-acoes">
        <h3>âš¡ AÃ§Ãµes</h3>
        <div class="actions">
          {% if eh_criador %}
          <button type="button" class="btn" onclick="abrirModal('adicionar')">
            â• Adicionar Recompensa
          </button>
          <button type="button" class="btn warn" onclick="abrirModal('editar')">
            âœï¸ Gerenciar Recompensas
          </button>
          {% endif %}
          <button type="button" class="btn secondary" onclick="voltarParaProjeto()">
            Voltar ao Projeto
          </button>
          <button type="button" id="btnRecomecar" class="btn danger" onclick="recomecar()" style="display:none">
            ğŸ”„ RecomeÃ§ar Jogo
          </button>
        </div>
      </div>

      <!-- InformaÃ§Ãµes do Jogador -->
      <div class="info-jogador">
        <h4> Jogador Atual</h4>
        <div class="jogador-atual" id="nome-jogador-display">
          {{ nome_usuario or 'Jogador' }}
        </div>
        <div class="posicao-atual">
          PosiÃ§Ã£o: <span id="posicao-atual">1</span> de 100
        </div>
        <div class="info-projeto">
          Projeto: <strong>{{ projeto.nome }}</strong>
        </div>
      </div>

    </div>
  </div>

  <!-- SeÃ§Ã£o de Recompensas Ganhas -->
  <div class="recompensas-ganhas">
    <h2>ğŸ† Recompensas Conquistadas</h2>
    <div class="grid-recompensas" id="grid-recompensas">
      <div class="sem-dados">Carregando recompensas conquistadas...</div>
    </div>
  </div>

  <!-- Modal Adicionar Recompensa -->
  {% if eh_criador %}
  <div id="modal-adicionar" class="modal" role="dialog" aria-modal="true" aria-labelledby="ttl-add">
    <div class="modal-card" style="max-width:450px;">
      <div class="modal-head" style="justify-content:center; margin-bottom:15px;">
        <h3 id="ttl-add" style="margin:0;">â• Adicionar Recompensa</h3>
      </div>
      <div class="modal-body">
        <form method="POST" action="{{ url_for('tabuleiro.adicionar_recompensa', id_projeto=projeto.id_projeto) }}">
          <div class="row" style="flex-direction:column;gap:12px;">
            <input type="text" name="titulo" placeholder="TÃ­tulo da recompensa" required>
            <input type="text" name="descricao" placeholder="DescriÃ§Ã£o detalhada" required>
            <input type="number" name="posicao" min="1" max="100" placeholder="NÃºmero da casa (1-100)" required>
          </div>
          <div class="right" style="justify-content:center;margin-top:20px;gap:10px;">
            <button type="submit" class="btn">ğŸ’¾ Salvar</button>
            <button type="button" class="btn danger" onclick="fecharModal('adicionar')">âŒ Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Modal Editar Recompensas -->
  {% if eh_criador %}
  <div id="modal-editar" class="modal" role="dialog" aria-modal="true" aria-labelledby="ttl-edit">
    <div class="modal-card">
      <div class="modal-head" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h3 id="ttl-edit">âœï¸ Gerenciar Recompensas</h3>
        <span class="pill">{{ recompensas|length }} recompensa(s)</span>
      </div>
      <div class="modal-body">
        {% if recompensas and recompensas|length > 0 %}
          {% for r in recompensas %}
          <form class="row" method="POST" action="{{ url_for('tabuleiro.editar_recompensa', id_projeto=projeto.id_projeto, id_recompensa=r.id_recompensa) }}">
            <input type="text" name="titulo" value="{{ r.titulo }}" placeholder="TÃ­tulo" required>
            <input type="text" name="descricao" value="{{ r.descricao }}" placeholder="DescriÃ§Ã£o" required>
            <input type="number" name="posicao" value="{{ r.posicao }}" min="1" max="100" placeholder="Casa" required style="flex:0 0 100px">
            <button class="btn" type="submit" style="flex:0 0 auto">ğŸ’¾</button>
            <button class="btn danger" type="button" onclick="confirmarExclusao({{ r.id_recompensa }})" style="flex:0 0 auto">ğŸ—‘ï¸</button>
          </form>
          <div class="hr"></div>
          {% endfor %}
        {% else %}
          <p style="text-align:center; padding:20px; color:#666;">Nenhuma recompensa cadastrada ainda.</p>
        {% endif %}
      </div>
      <div class="right">
        <button type="button" class="btn" onclick="fecharModal('editar')">Fechar</button>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Modal de VitÃ³ria -->
  <div id="modal-ganhou" class="modal" role="dialog" aria-modal="true" aria-labelledby="ttl-win">
    <div class="modal-card win">
      <div class="win-title" id="ttl-win">ğŸ‰ ParabÃ©ns!</div>
      <p class="win-desc" id="textoRecompensa">VocÃª ganhou uma recompensa!</p>
      <div class="win-saldo" id="saldo-ganho">+5 de saldo!</div>
      <p class="win-desc" id="mensagem-recompensa">Continue jogando para ganhar mais recompensas!</p>
      <div class="right" style="justify-content:center; margin-top:20px">
        <button type="button" class="btn" onclick="fecharModal('ganhou')">Continuar Jogando</button>
      </div>
    </div>
  </div>

  <!-- Modal de InformaÃ§Ãµes da Casa -->
  <div id="modal-casa-info" class="modal" role="dialog" aria-modal="true">
    <div class="modal-card casa-info">
      <div class="info-casa-titulo" id="casa-titulo">Casa 1</div>
      <div class="info-casa-numero" id="casa-numero">PosiÃ§Ã£o: 1</div>
      <div class="info-casa-descricao" id="casa-descricao">
        Esta Ã© uma casa comum do tabuleiro.
      </div>
      {% if eh_criador %}
      <div class="right" style="justify-content:center; gap:10px;">
        <button type="button" class="btn" onclick="editarRecompensaCasa()">âœï¸ Editar Recompensa</button>
        <button type="button" class="btn" onclick="adicionarRecompensaCasa()">â• Adicionar Recompensa</button>
      </div>
      {% endif %}
      <div class="right" style="justify-content:center; margin-top:15px;">
        <button type="button" class="btn" onclick="fecharModal('casa-info')">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Modal de ConfirmaÃ§Ã£o de ExclusÃ£o -->
  {% if eh_criador %}
  <div id="modal-confirmacao" class="modal" role="dialog" aria-modal="true">
    <div class="modal-card" style="max-width:400px; text-align:center;">
      <h3 style="margin-bottom:15px;">Confirmar ExclusÃ£o</h3>
      <p style="margin-bottom:20px;">Tem certeza que deseja excluir esta recompensa?</p>
      <div class="right" style="justify-content:center; gap:10px;">
        <form id="form-excluir" method="POST" style="display:inline;">
          <button type="submit" class="btn danger">Sim, Excluir</button>
        </form>
        <button type="button" class="btn" onclick="fecharModal('confirmacao')">Cancelar</button>
      </div>
    </div>
  </div>
  {% endif %}

</div>

<script>
  window.recompensas = {{ recompensas | tojson }};
  window.nomeJogador = "{{ (nome_usuario or 'Jogador') | e }}";
  window.posicaoAtual = {{ progresso.posicao_atual if progresso else 0 }};
  window.saldo = {{ progresso.saldo if progresso else 0 }};
  window.idProjeto = {{ projeto.id_projeto }};
  window.ehCriador = {% if eh_criador %}true{% else %}false{% endif %};
  window.usuariosOnline = {{ usuarios_online | tojson }};
  window.recompensasGanhas = {{ recompensas_ganhas | tojson }};
</script>
<script src="{{ url_for('static', filename='js/tabuleiro.js') }}"></script>
{% endblock %}